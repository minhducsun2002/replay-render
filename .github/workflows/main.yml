# This is a basic workflow to help you get started with Actions

name: Test

# Controls when the workflow will run
on:
  push:
    branches:
    - danser
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4
      - name: Prepare replay metadata extractor
        run: git clone https://github.com/minhducsun2002/replay-meta-list -b metadata; cd replay-meta-list; cargo build --release
      - name: Install deps
        run: |
          sudo apt-get -qq -o=Dpkg::Use-Pty=0 -y update;
          sudo apt-get -qq -o=Dpkg::Use-Pty=0 -y install ffmpeg libavcodec-dev libavutil-dev libavformat-dev libswresample-dev libswscale-dev;
      - name: Download skin
        run: |
          mkdir ~/Skins ~/Songs
          wget -q https://cdn.discordapp.com/attachments/876678911990308924/876679502405701722/Blueberry-v1.3.2-mod-normal-trails.osk -O /tmp/skin.zip;
          unzip /tmp/skin.zip -d ~/Skins/blueberry
      - name: Download replay
        run: |
          wget -q https://cdn.discordapp.com/attachments/876678911990308924/876678956529639454/Akane_Butterfly_-_Imperial_Circus_Dead_Decadence_-_Uta_Poetry_2021-06-02_Osu.osr -O ~/replay.osr
      - name: Download beatmap
        env:
          API_KEY: ${{ secrets.OSU_API_KEY }}
        run: |
          $GITHUB_WORKSPACE/replay-meta-list/target/release/replay-metadata ~/replay.osr > /tmp/metadata.json
          BEATMAPSET="$(cat /tmp/metadata.json | jq -r .beatmap_hash)"
          SET_ID="$(curl -qq "https://osu.ppy.sh/api/get_beatmaps?k=$API_KEY&h=$BEATMAPSET" | jq -r ".[0].beatmapset_id")"
          wget -q "beatconnect.io/b/$SET_ID" -O ~/beatmap.osz
          unzip ~/beatmap.osz -d ~/Songs/beatmap
      - name: Render
        env:
          WEBHOOK: ${{ secrets.WEBHOOK }}
        run: |
          Xvfb :1 & 
          export DISPLAY=:1
          wget -q https://github.com/Wieku/danser-go/releases/download/0.5.2/danser-0.5.2-linux.zip -O danser.zip
          unzip danser.zip -d danser;
          cd danser;
          chmod +x danser
          mv ../settings.json settings.json
          echo "\`\`\`$(jq . /tmp/metadata.json | jq -Rs . | cut -c 2- | rev | cut -c 2- | rev)\`\`\`" > file.json
          
          wget -q https://github.com/ChaoticWeg/discord.sh/raw/master/discord.sh;
          chmod +x discord.sh;
          ./discord.sh --webhook-url="$WEBHOOK" --text "Rendering started!\nMetadata :$(cat file.json)\nSee $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID."
          ./danser -record -replay ~/replay.osr
          ./discord.sh --webhook-url="$WEBHOOK" --text "Rendering is done! See $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID."
          mv videos/danser*.mp4 video.mp4
      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v2.2.4
        with:
          # Artifact name
          name: video # optional, default is artifact
          # A file, directory or wildcard pattern that describes what to upload
          path: danser/video.mp4
          # The desired behavior if no files are found using the provided path.
          
