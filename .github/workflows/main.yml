# This is a basic workflow to help you get started with Actions

name: Test

# Controls when the workflow will run
on:
  push:
    branches:
    - master
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4
      - name: Clone osr2mp4
        run: git clone https://github.com/uyitroa/osr2mp4-core;
      - name: Prepare replay metadata extractor
        run: git clone https://github.com/minhducsun2002/replay-meta-list -b metadata; cd replay-meta-list; cargo build --release
      - name: Install deps
        run: |
          sudo apt-get -qq -o=Dpkg::Use-Pty=0 -y update;
          sudo apt-get -qq -o=Dpkg::Use-Pty=0 -y install ffmpeg libavcodec-dev libavutil-dev libavformat-dev libswresample-dev libswscale-dev;
          cd osr2mp4-core; cd osr2mp4/; python install.py; pip install Pillow-SIMD PIL cython;
      - name: Prepare ImageProcess
        run: cd osr2mp4-core; cd osr2mp4/ImageProcess/Curves/libcurves/; python setup.py build_ext --inplace;
      - name: Prepare VideoProcess
        run: cd osr2mp4-core; cd osr2mp4/VideoProcess/FFmpegWriter/; python setup.py build_ext --inplace;
      - name: Download skin
        run: |
          wget -q https://cdn.discordapp.com/attachments/876678911990308924/876679502405701722/Blueberry-v1.3.2-mod-normal-trails.osk -O /tmp/skin.zip;
          unzip /tmp/skin.zip -d ~/skin
          wget -q https://cdn.discordapp.com/attachments/876678911990308924/876879456814399528/skin-default.zip -O /tmp/skin-default.zip
          unzip /tmp/skin-default.zip -d ~/skin-default
      - name: Download replay
        run: |
          wget -q https://cdn.discordapp.com/attachments/876678911990308924/876678956529639454/Akane_Butterfly_-_Imperial_Circus_Dead_Decadence_-_Uta_Poetry_2021-06-02_Osu.osr -O ~/replay.osr
      - name: Download beatmap
        env:
          API_KEY: ${{ secrets.OSU_API_KEY }}
        run: |
          BEATMAPSET="$($GITHUB_WORKSPACE/replay-meta-list/target/release/replay-metadata ~/replay.osr | jq -r .beatmap_hash)"
          SET_ID="$(curl -qq "https://osu.ppy.sh/api/get_beatmaps?k=$API_KEY&h=$BEATMAPSET" | jq -r ".[0].beatmapset_id")"
          wget -q "beatconnect.io/b/$SET_ID" -O ~/beatmap.osz
          unzip ~/beatmap.osz -d ~/beatmap
      - name: Render
        run: |
          cd osr2mp4-core;
          echo 4294967296 | sudo tee /proc/sys/fs/file-max
          git -c user.name=no -c user.email=no@no.com revert 963cf35775bd76b7f2ac323e021a2d1aa428b4cc --no-edit; cp ../*.py .; python main.py
          
        
          
